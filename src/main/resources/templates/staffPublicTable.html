<!DOCTYPE html>
<html lang="en" xmlns:th="http://www.thymeleaf.org">
  <head>
    <style>
      .centered {
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
      }
    </style>

    <div th:replace="common :: header"></div>
    <title>Staff</title>

    <nav class="navbar navbar-dark fixed-top" style="background: #1e3770">
      <div class="container-fluid">
        <a
          class="navbar navbar-brand"
          style="font-size: 28px; margin-left: 128px"
          href="#"
        >
          Cowin Lite
        </a>
      </div>
    </nav>
    <nav class="navbar navbar-dark fixed-bottom" style="background: #1e3770">
      <div class="container-fluid">
        <span class="navbar-brand mx-auto"
          >Optimize IT Systems Â© 2021 COWIN Lite</span
        >
      </div>
    </nav>
  </head>

  <body style="margin-top: 100px; margin-bottom: 80px">
    <div id="userName" th:text="${user.name}"></div>

    <h3>Registered Users</h3>
    <div class="mb-3 mt-3">
      <table id="dtUsers" class="table table-striped table-bordered">
        <thead class="table-dark">
          <tr style="font-size: 20px">
            <th>#</th>
            <th>Name</th>
            <th>Phone</th>
            <th>Adhaar</th>
            <th>Vaccination Status</th>
            <th>Update</th>
          </tr>
        </thead>
        <tbody>
          <tr style="font-size: 18px" th:each="member, iterStat:${members}">
            <td th:text="${iterStat.index}+1"></td>
            <td th:text="${member.memberName}"></td>
            <td th:text="${member.phnNumber}"></td>
            <td th:text="${member.adhaar}"></td>
            <td th:text="${member.vaccinationStatus}"></td>
            <td>
              <button id="edit_btn" type="button" class="btn btn-info">
                Update
              </button>
            </td>
          </tr>
        </tbody>
      </table>
    </div>
  </body>

  <div th:replace="common :: footer"></div>

  <script>
    $(document).ready(function () {
      $("#dtUsers").DataTable();
    });

    $(document).on("click", "#edit_btn", function () {
      var id = $(this).closest("tr").find("td:eq(0)").text();
      var memberName = $(this).closest("tr").find("td:eq(1)").text();
      var phnNumber = $(this).closest("tr").find("td:eq(2)").text();
      var adhaar = $(this).closest("tr").find("td:eq(3)").text();
      var vaccinationStatus = $(this).closest("tr").find("td:eq(4)").text();
      console.log(
        id +
          " " +
          memberName +
          " " +
          phnNumber +
          " " +
          adhaar +
          " " +
          vaccinationStatus
      );

      $.confirm({
        title: "Edit Vaccination Details",
        content:
          "" +
          '<form action="" class="formName">' +
          '<div class="form-group">' +
          "<label>Vaccine</label>" +
          '<select class="vaccinationType form-control" name="vax" id="vax" required>' +
          '<option value="COVISHIELD">COVISHIELD</option>' +
          '<option value="COVAXIN">COVAXIN</option>' +
          "</select>" +
          "</div>" +
          "<br/>" +
          '<div class="form-group">' +
          "<label>Vaccination Centre</label>" +
          '<input type="text" placeholder="Vaccination Centre" class="vaccinationCentre form-control" required/>' +
          "</div>" +
          "</form>",
        closeIcon: true,
        animation: "scale",
        backgroundDismiss: true,
        escapeKey: true,
        buttons: {
          formSubmit: {
            text: "Submit",
            btnClass: "btn-blue",
            action: function () {
              var vaccinationType = this.$content
                .find(".vaccinationType")
                .val();
              var vaccinationCentre = this.$content
                .find(".vaccinationCentre")
                .val();
              var userName = $("#userName").text();

              if (!vaccinationType || !vaccinationCentre) {
                $.alert("Please enter the details.");
                return false;
              }

              var formData = {
                phnNumber: phnNumber,
                name: userName,
                memberName: memberName,
                adhaar: adhaar,
                vaccinationStatus: vaccinationStatus,
                vaccinationType: vaccinationType,
                vaccinationCentre: vaccinationCentre,
                vaccinationBy: userName,
                vaccinationDate:
                  new Date().getDate() +
                  "/" +
                  (new Date().getMonth() + 1) +
                  "/" +
                  new Date().getFullYear(),
                nextVaccinationDate: "",
              };
              console.log(formData);

              $.ajax({
                type: "POST",
                contentType: "application/json",
                url: "/staff",
                data: JSON.stringify(formData),
                success: function (result) {
                  console.log(result);
                  if (result == "success") {
                    $.confirm({
                      title: "Success!",
                      content: "Vaccination details updated successfully!",
                      type: "green",
                      typeAnimated: true,
                      buttons: {
                        tryAgain: {
                          text: "Ok",
                          btnClass: "btn-green",
                          action: function () {
                            location.reload();
                          },
                        },
                      },
                    });
                  } else {
                    $.confirm({
                      title: "Error!",
                      content: "Vaccination details updation failed!",
                      type: "red",
                      typeAnimated: true,
                      buttons: {
                        tryAgain: {
                          text: "Ok",
                          btnClass: "btn-red",
                          action: function () {
                            location.reload();
                          },
                        },
                      },
                    });
                  }
                },
                error: function (e) {
                  console.log(e);
                  $.alert("Error in updating vaccination details!");
                },
              });
            },
          },
          cancel: function () {
            //close
          },
        },
      });
    });
  </script>
</html>
